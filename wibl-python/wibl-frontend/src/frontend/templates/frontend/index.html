{% extends "base_nav.html" %}

{% load static %}

{% block content %}
    <script src="{% static 'frontend/js/ol.js' %}"></script>
    <script src="{% static 'frontend/js/SocketManager.js' %}"></script>
    <script type="module" src="{% static 'frontend/js/IndexEventManager.js' %}"></script>
    <script type="module" src="{% static 'frontend/js/WIBLDetailTable.js' %}"></script>
    <script type="module" src="{% static 'frontend/js/WIBLFileTable.js' %}"></script>
    <script type="module" src="{% static 'frontend/js/GeojsonDetailTable.js' %}"></script>
    <script type="module" src="{% static 'frontend/js/GeojsonFileTable.js' %}"></script>
    <link rel="stylesheet" href="{% static 'frontend/css/ol.css' %}">
    <section class="container is-fluid">
        <div class="columns is-centered">
            <div class="column"  id="tableColumn">
                <div class="box">
                    <span class="is-size-4 has-text-weight-semibold">WIBL files</span>
                    <label for="linkBox">Link Files</label>
                    <input type="checkbox" id="linkBox" value="true">
                    <div class="block" style="margin-top: 0.5rem;">
                         <wibl-file-table id="wibl-file-table"
                                   url="{{ wsURL }}"
                                   stylesheet="{% static 'css/bulma-no-dark-mode.min.css' %}">
                        </wibl-file-table>
                        <span class="is-hidden" id="filterErrorMessage"></span>
                    </div>
                </div>
                <div class="box">
                    <span class="is-size-4 has-text-weight-semibold">GeoJSON files</span>
                    <div class="block" style="margin-top: 0.5rem;">
                        <geojson-file-table id="geojson-file-table"
                                       url="{{ wsURL }}"
                                       stylesheet="{% static 'css/bulma-no-dark-mode.min.css' %}">
                        </geojson-file-table>
                    </div>
                </div>
                <div class="block">
                    <button id="deleteButton" class="button">Delete Selected</button>
                    <button id="downloadButton" class="button">Download Selected</button>
                    <button class="button" id="mapButton">Map Files</button>
                    <button class="button" id="showButton">Filter</button>
                </div>
                <div class="box is-hidden" id="filterSection">
                    <div class="block">
                        <button class="button" id="filterButton">Apply</button>
                        <button class="button" id="clearButton">Clear</button>
                    </div>
                    <div class="block">
                        <div class="columns">
                            <div class="column is-half">
                                <label for="dateInput">Date</label>
                                <input type="date" class="input" id="dateInput">
                            </div>
                            <div class="column is-half">
                                <label for="timeInput">Time ("HH:MM")</label>
                                <input type="text" class="input" id="timeInput">
                            </div>
                        </div>
                            <label for="platformInput">Platform</label>
                            <input type="text" class="input" id="platformInput">

                            <label for="loggerInput">Logger</label>
                            <input type="text" class="input" id="loggerInput">
                    </div>
                </div>
            </div>
            <div class="column" id="detailColumn">
                <div class="box is-sticky" id="detailBlock">
                    <div class="tabs is-centered is-boxed">
                        <ul>
                            <li class="is-active" data-target="wibl-detail-table"><a>WIBL Details</a></li>
                            <li data-target="geojson-detail-table"><a>Geojson Details</a></li>
                            <li data-target="map"><a>Geojson Map</a></li>
                        </ul>
                    </div>
                    <geojson-detail-table id="geojson-detail-table"
                        url="{{ wsURL }}"
                        stylesheet="{% static 'css/bulma-no-dark-mode.min.css' %}"
                        class="table is-hidden">
                    </geojson-detail-table>
                    <wibl-detail-table id="wibl-detail-table"
                        url="{{ wsURL }}"
                        stylesheet="{% static 'css/bulma-no-dark-mode.min.css' %}"
                        class="table">
                    </wibl-detail-table>
                    <div id="map" class="is-hidden" style="width: 100%; height: 500px;"></div>
                    <div id="popup" class="ol-popup">
                      <a href="#" id="popup-closer" class="ol-popup-closer"></a>
                      <div id="popup-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <style>
        :root {
            --bulma-link-text: hsla(171deg, 100%, 30%, 1);
        }
        #filterErrorMessage {
            font-weight: bold;
        }
        #tableColumn {
            max-width: 47rem;
        }
        #detailColumn {
            max-width: 38rem;
        }

        .is-sticky {
            position: sticky;
            top: 1rem;
        }

        .ol-popup {
        position: absolute;
        background-color: white;
        box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #cccccc;
        bottom: 12px;
        left: -50px;
        min-width: 280px;
      }
      .ol-popup:after, .ol-popup:before {
        top: 100%;
        border: solid transparent;
        content: " ";
        height: 0;
        width: 0;
        position: absolute;
        pointer-events: none;
      }
      .ol-popup:after {
        border-top-color: white;
        border-width: 10px;
        left: 48px;
        margin-left: -10px;
      }
      .ol-popup:before {
        border-top-color: #cccccc;
        border-width: 11px;
        left: 48px;
        margin-left: -11px;
      }
      .ol-popup-closer {
        text-decoration: none;
        position: absolute;
        top: 2px;
        right: 8px;
      }
      .ol-popup-closer:after {
        content: "âœ–";
      }
    </style>
    <script type="module">

        import { WIBLFileTable } from '/static/frontend/js/WIBLFileTable.js';
        import { GeojsonFileTable } from '/static/frontend/js/GeojsonFileTable.js';

        const wiblFileTable = document.getElementById("wibl-file-table");
        const geojsonFileTable = document.getElementById("geojson-file-table");

        // Request WIBL file data from the WebSocket once the DOM is ready; do this here instead of in the
        // components to that the request is only sent once.
        setTimeout(() => {
            const wiblSockType = "wibl";
            const wiblSockUrl = "{{ wsURL }}" + "wibl/table";
            const wiblSock = SocketManager.getInstance(wiblSockUrl, wiblSockType);

            const geojsonSockType = "geojson";
            const geojsonSockUrl = "{{wsURL}}" + "geojson/table";
            const geojsonSock = SocketManager.getInstance(geojsonSockUrl, geojsonSockType);

            wiblSock.sendRequest("list-wibl-files");
            geojsonSock.sendRequest("list-geojson-files");
        });

        // OpenLayers
        var olMap;
        const mapButton = document.getElementById("mapButton");
        var overlay;

        const container = document.getElementById('popup');
        const content = document.getElementById('popup-content');
        const closer = document.getElementById('popup-closer');

        mapButton.addEventListener("click", (event) => {
            const files = geojsonFileTable.getSelectedFiles(3);

            const tabs = document.querySelectorAll(".tabs ul li");
            let geoTab;
            tabs.forEach((tab) => {
                if (tab.getAttribute("data-target") === "map") {
                    geoTab = tab;
                }
            });
            geoTab.click();

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                loadGeojson(olMap, file);
            }
        });

        function renderTable(data, container) {
            const tableHTML = `
                <div class="fixed-grid">
                    <div class="grid">
                        ${Object.entries(data)
                            .map(([key, value]) => `<div class="cell has-border">${key}</div><div class="cell has-border">${value}</div>`)
                            .join("")}
                    </div>
                </div>
            `;

            container.innerHTML = tableHTML;
        }

        function getFeaturesExtent(features) {
            let extent = features[0].getGeometry().getExtent();

            for (let feature of features) {
                ol.extent.extend(extent, feature.getGeometry().getExtent());
            }

            return extent;
        }

        function calculateZoom(map, features) {
            const extent = getFeaturesExtent(features);
            const mapSize = map.getSize();
            const view = map.getView();

            const resolution = view.getResolutionForExtent(extent, mapSize);

            return view.getZoomForResolution(resolution);
        }

        async function loadGeojson(map, fileid) {
            let layers = map.getLayers();
            for (let layer of layers.array_) {
                if (layer.className_ !== "ol-layer") {
                    map.removeLayer(layer);
                }
            }
            try {
                const res = await fetch(`./saveGeojsonFile/${fileid}`);
                if (!res.ok) {
                    throw new Error(`HTTP error! Status: ${res.status}`);
                }
                const geojsonObject = await res.json();

                const geojsonFormat = new ol.format.GeoJSON();
                const features = geojsonFormat.readFeatures(geojsonObject.geojson, {
                    featureProjection: 'EPSG:4326'
                });

                var avg_X = 0;
                var avg_Y = 0;

                let all_X_Coordinates = 0;
                let all_Y_Coordinates = 0;

                for (let feature of features) {
                    let coordinates = feature.getGeometry().getCoordinates();
                    all_X_Coordinates += coordinates[0];
                    all_Y_Coordinates += coordinates[1];
                }

                avg_X = all_X_Coordinates / features.length;
                avg_Y = all_Y_Coordinates / features.length;


                const vectorSource = new ol.source.Vector({
                    features: features
                });

                const vectorLayer = new ol.layer.Vector({
                    source: vectorSource,
                    className: `ol-${fileid}`
                });

                map.addLayer(vectorLayer);

                // const extent = getFeaturesExtent(features);
                // map.getView().fit(extent, { padding: [50,50,50,50], duration: 1000, constrainResolution: false});
                map.getView().setCenter([avg_X, avg_Y]);
                const zoom = calculateZoom(map, features);
                map.getView().setZoom(zoom == 0 ? zoom: zoom - 1);

                const selectInteraction = new ol.interaction.Select({
                    condition: ol.events.condition.click,
                    layers: [vectorLayer]
                });

                map.addInteraction(selectInteraction);

                selectInteraction.on('select', function (event) {
                    if (event.selected.length > 0) {
                        const feature = event.selected[0];
                        const properties = feature.getProperties();
                        delete properties.geometry;

                        let coordinates = feature.getGeometry().getCoordinates();
                        renderTable(properties, content);
                        overlay.setPosition(coordinates);
                    }
                });

                closer.onclick = function () {
                    overlay.setPosition(undefined);
                    closer.blur();
                    selectInteraction.getFeatures().clear();
                    return false;
                };
            } catch (error) {
                console.error('Error loading GeoJSON:', error);
            }
        }

        document.addEventListener("DOMContentLoaded", function () {

            overlay = new ol.Overlay({
              element: container,
              autoPan: {
                animation: {
                  duration: 250,
                },
              },
            });

            olMap = new ol.Map({
                target: 'map',
                overlays: [overlay],
                layers: [
                    new ol.layer.Tile({
                      source: new ol.source.OSM(),
                    }),
                ],
                view: new ol.View({
                    projection: "EPSG:4326",
                    center: [0, 0],
                    zoom: 0,
                }),
            });


            const tabs = document.querySelectorAll(".tabs ul li");
            const tables = document.querySelectorAll(".table");
            const map = document.getElementById("map");

            tabs.forEach(tab => {
                tab.addEventListener("click", function () {
                    tabs.forEach(t => t.classList.remove("is-active"));
                    this.classList.add("is-active");

                    tables.forEach(table => table.classList.add("is-hidden"));
                    map.classList.add("is-hidden");

                    const target = this.getAttribute("data-target");
                    document.getElementById(target).classList.remove("is-hidden");
                });
            });
        });

        // Delete button logic
        // Must be in index so it can use the wsURL context provided by the index view
        const deleteButton = document.getElementById("deleteButton");
        deleteButton.addEventListener("click", (event) => {
            let wiblResult = wiblFileTable.getSelectedFiles(0);
            let geojsonResult = geojsonFileTable.getSelectedFiles(0);
            if (wiblResult != 0) {
                const wiblSockType = "wibl";
                const wiblSockUrl = "{{ wsURL }}" + wiblSockType + "/table";
                const wiblSock = SocketManager.getInstance(wiblSockUrl, wiblSockType);
                wiblSock.sendRequest("delete-wibl-files", {"file_ids" : wiblResult});
                wiblSock.sendRequest("list-wibl-files");
            }

            if (geojsonResult != 0) {
                const geojsonSockType = "geojson";
                const geojsonSockUrl = "{{wsURL}}" + geojsonSockType +"/table";
                const geojsonSock = SocketManager.getInstance(geojsonSockUrl, geojsonSockType);
                geojsonSock.sendRequest("delete-geojson-files", {"file_ids" : geojsonResult});
                geojsonSock.sendRequest("list-geojson-files");
            }
        })

        const linkBox = document.getElementById("linkBox");
        let linkFlag = false;

        let linked_files = [];

        function linkFiles() {
            let geojsonFiles = [];
            let wiblFiles = [];
            for (let i = 0; i < geojsonFileTable._rawData.length; i++) {
                const geojsonRaw = geojsonFileTable._rawData[i];
                geojsonFiles.push(geojsonRaw[0]);
            }

            for (let i = 0; i < wiblFileTable._rawData.length; i++) {
                const wiblRaw = wiblFileTable._rawData[i];
                wiblFiles.push(wiblRaw[0]);
            }

            linked_files = [];
            for (let i = 0; i < geojsonFiles.length; i++) {
                for (let x = 0; x < wiblFiles.length; x++) {
                    const geojsonRootFile = geojsonFiles[i].split(".");
                    const wiblRootFile = wiblFiles[x].split(".");
                    if (geojsonRootFile[0] === wiblRootFile[0]) {
                        linked_files.push(wiblRootFile[0]);
                    }
                }
            }
        }

        document.addEventListener("linkFilesEvent", (event) => {
            linkFiles();
        });

        linkBox.addEventListener("change", (event) => {
            if (!linkFlag) {
                linkFiles();
            }
            linkFlag = !linkFlag;
        });

        function tableSelectEvent(fileTable, event) {
            const path = event.composedPath();
            const check = path.find(el => el.tagName === "INPUT");
            if (!check) {
                const row = path.find(el => el.tagName === "TR");
                if (row) {
                    if (row.className !== "headerRow") {
                        fileTable.clearCSS();

                        row.setAttribute("class", "is-selected");

                        let linked_file_exists = false;
                        if (linkFlag === true) {
                            const root_file = row.id.split(".")[0];
                            linked_files.forEach(linked_file => {
                                 if (root_file === linked_file) {
                                     linked_file_exists = true;
                                 }
                            });
                        }
                        setTimeout(() => {
                            if (fileTable instanceof WIBLFileTable) {
                                const wiblSockType = "wibl";
                                const wiblSockUrl = "{{ wsURL }}" + wiblSockType + "/detail";
                                const wiblSock = SocketManager.getInstance(wiblSockUrl, wiblSockType);

                                const wiblFileId = row.id;

                                if (linkFlag) {
                                    geojsonFileTable.clearCSS();
                                }

                                if (linked_file_exists) {
                                    let geojsonFileId = row.id.split(".")[0];
                                    geojsonFileId += ".geojson";

                                    const geojsonRow = geojsonFileTable._shadow.getElementById(geojsonFileId);
                                    geojsonRow.setAttribute("class", "is-selected");

                                    const geojsonSockType = "geojson";
                                    const geojsonSockUrl = "{{wsURL}}" + geojsonSockType + "/detail";
                                    const geojsonSock = SocketManager.getInstance(geojsonSockUrl, geojsonSockType);

                                    geojsonSock.sendRequest("list-geojson-details", {"file_id" : geojsonFileId});
                                }
                                wiblSock.sendRequest("list-wibl-details", {"file_id" : wiblFileId});

                            } else if (fileTable instanceof GeojsonFileTable) {
                                const geojsonSockType = "geojson";
                                const geojsonSockUrl = "{{ wsURL }}" + geojsonSockType + "/detail";
                                const geojsonSock = SocketManager.getInstance(geojsonSockUrl, geojsonSockType);

                                const geojsonFileId = row.id;

                                if (linkFlag) {
                                    wiblFileTable.clearCSS();
                                }

                                if (linked_file_exists) {
                                    let wiblFileId = row.id.split(".")[0];
                                    wiblFileId += ".wibl";

                                    const wiblRow = wiblFileTable._shadow.getElementById(wiblFileId);
                                    wiblRow.setAttribute("class", "is-selected");

                                    const wiblSockType = "wibl";
                                    const wiblSockUrl = "{{ wsURL }}" + wiblSockType + "/detail";
                                    const wiblSock = SocketManager.getInstance(wiblSockUrl, wiblSockType);
                                    wiblSock.sendRequest("list-wibl-details", {"file_id" : wiblFileId});
                                }

                                geojsonSock.sendRequest("list-geojson-details", {"file_id" : geojsonFileId});
                            }
                        });
                    }
                }
            }
        }


        wiblFileTable.addEventListener("click", (event) => {
            tableSelectEvent(wiblFileTable, event);
        });

        //Detail File Table Logic
        geojsonFileTable.addEventListener("click", (event) => {
            tableSelectEvent(geojsonFileTable, event);
        });

    </script>
{% endblock %}

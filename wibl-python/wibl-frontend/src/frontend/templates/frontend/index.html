{% extends "base_nav.html" %}

{% load static %}

{% block content %}
    <script src="{% static 'frontend/js/SocketManager.js' %}"></script>
    <script src="{% static 'frontend/js/WIBLFileList.js' %}"></script>
    <script type="module" src="{% static 'frontend/js/WIBLDetailTable.js' %}"></script>
    <script type="module" src="{% static 'frontend/js/WIBLFileTable.js' %}"></script>

    <section class="container">
      <div class="columns">
        <div class="column is-2-thirds">
          <span class="is-size-4 has-text-weight-semibold">WIBL files</span>
          <wibl-file-table id="wibl-file-table"
                           url="{{ wsURL }}"
                           stylesheet="{% static 'css/bulma-no-dark-mode.min.css' %}">
          </wibl-file-table>
            <button id="deleteButton" class="button">Delete Selected</button>
            <button id="archiveButton" class="button">Archive Selected</button>
        </div>

        <div class="column is-one-third">
          WIBL details...
          <ul id="wibl-detail-list">

          </ul>
          <wibl-detail-table id="wibl-detail-table"
                          url="{{ wsURL }}"
                          stylesheet="{% static 'css/bulma-no-dark-mode.min.css' %}">
          </wibl-detail-table>

        </div>
      </div>
    </section>

    <script>
        // Request WIBL file data from the WebSocket once the DOM is ready; do this here instead of in the
        // components to that the request is only sent once.
        setTimeout(() => {
            const wiblSockType = "wibl";
            const wiblSockUrl = "{{ wsURL }}" + wiblSockType + "/table";
            const wiblSock = SocketManager.getInstance(wiblSockUrl, wiblSockType);
            wiblSock.sendRequest("list-wibl-files");
        });
        const wiblFileTable = document.getElementById("wibl-file-table");
        wiblFileTable.addEventListener("click", (event) => {
            const path = event.composedPath();
            const row = path.find(el => el.tagName === "TR");
            if (row) {
                const rows = wiblFileTable._shadow.querySelectorAll('tr');
                rows.forEach(iter_row => {
                    if (iter_row.className === "is-selected") {
                       iter_row.setAttribute("class", "");
                    }
                })
                row.setAttribute("class", "is-selected");
                setTimeout(() => {
                    const wiblSockType = "wibl";
                    const wiblSockUrl = "{{ wsURL }}" + wiblSockType + "/detail";
                    const wiblSock = SocketManager.getInstance(wiblSockUrl, wiblSockType);
                    wiblSock.sendRequest("list-wibl-details", row.id);
                });
            }
        });
    </script>

    <script>


        const deleteButton = document.getElementById("deleteButton");
        const archiveButton = document.getElementById("archiveButton");
        deleteButton.addEventListener("click", (event) => {
            var wiblFileTable = document.getElementById("wibl-file-table");
            wiblFileTable.deleteSelectedFiles();
        })
        archiveButton.addEventListener("click", (event) => {
            var wiblFileTable = document.getElementById("wibl-file-table");
            wiblFileTable.archiveSelectedFiles();
        })
    </script>
{% endblock %}
